<!DOCTYPE html>
<html lang="en">
<head>
    <title>Multithreaded Programming</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta name="description" content="ESP web framework">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Open+Sans:300italic,400,300,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Julius+Sans+One' rel='stylesheet' type='text/css'>
    <link href="https://embedthis.com/esp/doc/ref/multithread.html" rel="canonical">
    <link href="../images/favicon.ico" rel="shortcut icon">
    <link href="../lib/semantic-ui/semantic.min.css" rel="stylesheet" type="text/css">
    <link href="../css/all.min.css" rel="stylesheet" type="text/css">
    <link href="../css/api.min.css" rel="stylesheet" type="text/css">
    

</head>
<body class="show-sidebar">
    <div class="sidebar">
        <div class="ui large left vertical inverted labeled menu">
            <div class="item">
                <a href="../index.html" class="logo">ESP Docs</a>
            </div>
            <div class="item">
                <a href="../index.html">
                    <b>General</b>
                </a>
                <div class="menu">
                    <a class="item" href="../index.html">ESP Overview</a>
                    <a class="item" href="../users/features.html">ESP Features</a>
                    <a class="item" href="https://embedthis.com/esp/download.html">Download</a>
                    <a class="item" href="../licensing/index.html">Licensing</a>
                </div>
            </div>
            <div class="item">
                <a href="../start/index.html">
                    <b>Getting Started</b>
                </a>
                <div class="menu">
                    <a class="item" href="../start/quick.html">Quick Start</a>
                    <a class="item" href="../start/installing.html">Installing ESP</a>
                    <a class="item" href="../start/tour.html">ESP Tour</a>
                    <a class="item" href="../start/app-tour.html">ESP Applications Tour</a>
                    <a class="item" href="../start/spa-tour.html">ESP SPA Tour</a>
                    <a class="item" href="../start/releaseNotes.html">Release Notes</a>
                    <a class="item" href="../start/source.html">Building from Source</a>
                </div>
            </div>
            <div class="item">
                <a href="../users/index.html"><b>User's Guide</b></a>
                <div class="menu">
                    <a class="item" href="../users/create.html">Creating ESP Applications</a>
                    <a class="item" href="../users/packages.html">Extension Packages</a>
                    <a class="item" href="../users/skeletons.html">Application Skeletons</a>
                    <a class="item" href="../users/config.html">Configuring ESP</a>
                    <a class="item" href="../users/components.html">Generating Components</a>
                    <a class="item" href="../users/building.html">Building Applications</a>
                    <a class="item" href="../users/deploying.html">Deploying Applications</a>
                    <a class="item" href="../users/pages.html">ESP Pages</a>
                    <a class="item" href="../users/layouts.html">Expansive Layouts</a>
                    <a class="item" href="../users/controllers.html">ESP Controllers</a>
                    <a class="item" href="../users/database.html">Databases</a>
                    <a class="item" href="../users/migrations.html">Database Migrations</a>
                    <a class="item" href="../users/sessions.html">Session Storage</a>
                    <a class="item" href="../users/security.html">Security Considerations</a>
                    <a class="item" href="../users/monitor.html">Monitoring and Defending</a>
                    <a class="item" href="../users/hosting.html">Hosting in Appweb</a>
                    <a class="item" href="../users/command.html">ESP Command</a>
                    <a class="item" href="../users/man.html">Manual Pages</a>
                </div>
            </div>
            <div class="item">
                <a href="../ref/index.html">Reference Guide</a>
                <div class="menu">
                    <a class="item" href="../ref/mvc.html">ESP MVC Framework</a>
                    <a class="item" href="../ref/compatibility.html">Compatibility</a>
                    <a class="item" href="../ref/native.html">API Library</a>
                    <a class="item" href="../ref/memory.html">ESP Memory Allocation</a>
                    <a class="item" href="../ref/multithread.html">Multithreaded Programming</a>
                </div>
            </div>
            <div class="item">
                <a href="../users/samples.html">Samples</a>
                <div class="menu">
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/config">config</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/controller">controller</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/html-mvc">html-mvc</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/layout">layout</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/login-database">login-database</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/login-form">login-form</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/login-roles">login-roles</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/page">page</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/session">session</a>
                  <a class="item" href="https://github.com/embedthis/esp/tree/dev/samples/upload">upload</a>
                </div>
            </div>
            <div class="item">
                <a href="../users/project.html">Project Resources</a>
                <div class="menu">
                    <a class="item" href="https://embedthis.com/blog/categories/ESP/">Official ESP News</a>
                    <a class="item" href="https://embedthis.com/esp/">ESP Web Site</a>
                    <a class="item" href="https://github.com/embedthis/esp">Source Code Repository</a>
                    <a class="item" href="https://github.com/embedthis/esp/issues">Project Issue Database</a>
                    <a class="item" href="https://github.com/embedthis/esp/releases">Change Log</a>
                    <a class="item" href="https://github.com/embedthis/esp/milestones">Roadmap</a>
                    <a class="item" href="https://embedthis.com/developers/contributors.html">Contributors Agreement</a>
                </div>
            </div>
            <div class="item">
                <b>Links</b>
                <div class="menu">
                    <a class="item" href="https://embedthis.com/">Embedthis Web Site</a>
                    <a class="item" href="https://embedthis.com/blog/">Embedthis Blog</a>
                    <a class="item" href="http://twitter.com/embedthat">Twitter</a>
                </div>
            </div>
        </div>
    </div>



    <div class="ui inverted masthead">
        <div class="ui fixed inverted menu">
            <div class="ui sidebar-launch button">
                <i class="icon list layout"></i>
            </div>
            <div class="right menu">
                <a class="item" href="https://embedthis.com/">Embedthis</a>
                    <a class="item" href="https://embedthis.com/esp/">ESP Site</a>
                    <span class="desktop-only">
                        <a class="item" href="https://embedthis.com/blog/categories/ESP/">ESP News</a>
                        <a class="item" href="https://github.com/embedthis/esp">Repository</a>
                        <a class="item" href="https://embedthis.com/blog/">Blog</a>
                        <a class="item" href="https://twitter.com/embedthat">Twitter</a>
                    </span>

            </div>
        </div>
        
        <div class="ui breadcrumb">
            <a class="section" href="../">Home</a>
            
            <div class="divider">/</div>
            <a class="section" href="index.html">
                Reference Guide
            </a>
            
            
            <div class="divider">/</div>
            <a class="active section" href="multithread.html">Multithreaded Programming</a>
            
        </div>
        
        <iframe class="version desktop-only" src="../version.html"></iframe>

    </div>
    <div class="content">

            <h1>Multithreaded Programming</h1>
            <a id="overview"></a>
            <h2>Overview</h2>
            <p>Programming in a multithreaded environment can be difficult. Sometimes programming errors are timing related 
            as multiple threads interact. Multithread locks can become tangled and bugs can be difficult to reproduce. 
            To alleviate these problems and
            enable the benefits of a multi-threaded core, ESP provides a suite of facilities to make multithreaded
            programming easier, more reliable, and more efficient.</p>
            <h3>The Problem of Multithreaded I/O Events</h3>
            <p>A particularly thorny issue in multithreaded servers is how to handle I/O without consuming a thread for
            each request. It is not practical to dedicate a thread to each HTTP request. A single browser will often
            send 6-10 simultaneous requests. If each request consumed a thread for the duration, the web server would
            quickly consume too many threads and system performance would greatly suffer. </p>
            <p>One solution is to use a thread pool. This allows a request to borrow a thread from a thread pool while 
            the request is active and return the thread when it cannot immediately continue with servicing the request. 
            A thread may
            not be able to continue because it is waiting for I/O from the client, or waiting for I/O to the client to 
            drain over the network. Returning the thread to the pool allows other requests to use the thread while the
            first request is waiting for network I/O. When the network is ready, a thread can be obtained from the pool
            and the original request can continue. For this to work, an efficient network event service is 
            essential. ESP uses such a thread pool and event service to efficiently manage thread resources. </p>
            
            <p>However, this use of such an event service and thread pool raises another problem: races between the 
            foreground request thread and the background async I/O event thread. It is easy for these two threads to 
            simultaneously interact and corrupt critical data structures. A typical solution is to use multithread
            locks to serialize access to such data, but this is a crude solution and often leads to brittle applications.
            ESP has a better solution that effectively serializes all activity for a request: per-request 
            event dispatchers.</p>
            <a id="dispatchers"></a>
            <h3>Event Dispatchers</h3>
            <p>The Multithreaded Portable Runtime (MPR) used by ESP has a facility called Event Dispatchers. These
            are event queues on which all I/O and other event activity for a request can be queued and serviced. 
            Each request has its own dispatcher and so events for a request are serialized.  When a network I/O event
            is received by ESP for a request, an event is queued on the request's dispatcher. If the request is 
            currently active (using a thread from the thread pool), the event is queued and no immediate action is taken. 
            When the request has finished its current activity, it will service events on its dispatcher queue and 
            eventually service the I/O event. If the request is currently idle, a thread is assigned from the thread 
            pool for the request, and the thread is resumed to service the request's dispatcher queue. This greatly 
            simplifies ESP as all activity for a request is thus serialized via the dispatcher queue.</p>
            <p>By using event dispatchers, multithread locking is not required on every API &mdash; because activity
            is serialized by the dispatcher. This significantly boosts performance and reduces the risk of lock contention.</p>
            <a id="multithreaded"></a>
            <h3>Multithreaded ESP</h3>
            <p>By using request dispatchers, ESP serializes all request activity, yet it can support many 
            simultaneous requests due to its multithreaded core. ESP efficiently utilizes thread resources by using
            a thread pool and not permanently dedicating threads to requests. Threads are temporarily assigned
            only as required by active requests.</p>
            <a id="modules"></a>
            <h3>Modules</h3>
            <p>ESP can be extended via ESP applications. These are loadable ESP web pages,
            and ESP Model-View-Controller applications. These can rely on the fact that request activity is serialized
            and locking primitives are typically not required. ESP code can thus be simple, 
            single-threaded application code.</p>
            
            <a id="locking"></a>
            <h3>Locking</h3>
            <p>If you have a requirement for a data structure that will be accessed and manipulated simultaneously
            by multiple threads, the MPR provides a suite of locking primitives. See
            <a href="../ref/api/mpr.html#group___mpr_sync">MprSync</a> for the MPR 
                Multithreaded Synchronization Services.</p>

    </div>
    <div class="terms ui basic center aligned segment">
        <p>&copy; Embedthis Software. All rights reserved.</p>
    </div>

    <script src="../lib/jquery/jquery.min.js"></script>
    <script src="../lib/semantic-ui/semantic.min.js"></script>
    <script src="../scripts/sidebar.min.js"></script>
     

    




